<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"/></head>
<body>
<h2>Add Student</h2>
<form th:action="@{/manager/add_student}" method="post">
  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
  <div><label>First name: <input type="text" name="firstName" required/></label></div>
  <div><label>Last name: <input type="text" name="lastName" required/></label></div>
  <div><label>Phone: <input type="text" name="phone"/></label></div>
  <div>
    <label>Package:
      <select name="packageType" required>
        <option th:each="p : ${packageTypes}" th:value="${p}" th:text="${p}"></option>
      </select>
    </label>
  </div>
  <div>
    <label>Teacher:
      <select id="teacherSelect" name="teacherId" required>
        <option value="">-- select teacher --</option>
        <option th:each="t : ${teachers}" th:value="${t.userId}" th:text="${t.firstName + ' ' + t.lastName}"></option>
      </select>
    </label>
  </div>

  <div>
    <label>Time (optional):
      <!-- вместо ввода id — селект с метками; value = timeSlot.id -->
      <select id="timeSlotSelect" name="timeSlotId">
        <option value="">-- no specific time --</option>
        <!-- options будут подгружены через JS при выборе учителя -->
      </select>
    </label>
  </div>

  <div>
    <label>Book: <input type="checkbox" name="book" value="true"/></label>
  </div>
  <div>
    <label>Debt: <input type="number" step="0.01" name="debt" value="0"/></label>
  </div>
  <div><button type="submit">Create Student</button></div>
</form>

<script>
  // Когда manager выбирает учителя — подгружаем его тимслоты и показываем удобные метки.
  document.addEventListener('DOMContentLoaded', function () {
    const teacherSelect = document.getElementById('teacherSelect');
    const timeSlotSelect = document.getElementById('timeSlotSelect');

    async function loadSlotsForTeacher(teacherId) {
      // очистим селект
      timeSlotSelect.innerHTML = '<option value="">-- no specific time --</option>';
      if (!teacherId) return;
      try {
        const res = await fetch('/manager/teacher_slots_json/' + teacherId);
        if (!res.ok) return;
        const slots = await res.json();
        slots.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.label;
          timeSlotSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load timeslots', err);
      }
    }

    // при загрузке страницы — если выбран учитель по умолчанию, загрузим его слоты
    if (teacherSelect.value) {
      loadSlotsForTeacher(teacherSelect.value);
    }

    teacherSelect.addEventListener('change', function () {
      loadSlotsForTeacher(this.value);
    });
  });
</script>
</body>
</html>