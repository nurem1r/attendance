<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Добавить студента</title>
  <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
</head>
<body>
<div class="container">
  <div class="header-row">
    <div class="header-left">
      <h1>Добавить студента</h1>
      <div class="small">Заполните данные студента</div>
    </div>
    <div class="header-actions">
      <form th:action="@{/logout}" method="post" th:object="${_csrf}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit" class="btn-consume">Выйти</button>
      </form>
    </div>
  </div>

  <div class="table-card">
    <form th:action="@{/manager/add_student}" method="post" id="addStudentForm">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <div class="form-row">
        <label>
          Фамилия
          <input class="input" type="text" name="lastName" required />
        </label>
        <label>
          Имя
          <input class="input" type="text" name="firstName" required />
        </label>
      </div>

      <div class="form-row">
        <label>
          Телефон
          <input class="input" type="text" name="phone" />
        </label>
        <label>
          Учитель
          <select class="input" name="teacherId" id="teacherSelect" required>
            <option value="">-- выберите учителя --</option>
            <option th:each="t : ${teachers}" th:value="${t.userId}" th:text="${t.firstName + ' ' + t.lastName}">Учитель</option>
          </select>
        </label>
      </div>

      <div class="form-row">
        <label style="flex:2">
          Пакет
          <select class="input" name="packageId" id="packageSelect" required>
            <option value="">-- выберите пакет --</option>
            <option th:each="p : ${packages}" th:value="${p.id}" th:text="${p.title + ' — ' + p.price + ' сом'}">12 lessons</option>
          </select>
        </label>

        <label>
          Первичный платёж (сом)
          <input class="input" type="number" step="0.01" name="initialPayment" value="0" />
        </label>
      </div>

      <!-- Новый блок: выбор time slot -->
      <div class="form-row" style="margin-top:8px">
        <label style="flex:1">
          Временной слот
          <select class="input" name="timeSlotId" id="timeSlotSelect">
            <option value="">-- выберите учителя сначала --</option>
          </select>
        </label>
        <div style="align-self:flex-end; margin-left:12px; color:#666; font-size:0.9em">
          (опционально)
        </div>
      </div>

      <div style="margin-top:12px">
        <button class="btn-consume" type="submit">Создать</button>
        <a th:href="@{/manager/student_list}" style="margin-left:8px" class="btn-consume">Отмена</a>
      </div>
    </form>
  </div>
</div>

<script>
  (function(){
    const teacherSelect = document.getElementById('teacherSelect');
    const timeSlotSelect = document.getElementById('timeSlotSelect');

    // Заполняет select опциями [{id,label}]
    function fillTimeSlots(slots){
      timeSlotSelect.innerHTML = '';
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '-- выберите слот --';
      timeSlotSelect.appendChild(emptyOpt);
      if(!slots || !Array.isArray(slots) || slots.length === 0){
        const none = document.createElement('option');
        none.value = '';
        none.textContent = 'Нет доступных слотов';
        timeSlotSelect.appendChild(none);
        return;
      }
      slots.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.label;
        timeSlotSelect.appendChild(opt);
      });
    }

    // Запрос слотов для выбранного teacherId
    function loadSlotsForTeacher(teacherId){
      if(!teacherId){
        timeSlotSelect.innerHTML = '<option value=\"\">-- выберите учителя сначала --</option>';
        return;
      }
      fetch('/manager/teacher_slots_json/' + teacherId, { credentials: 'same-origin' })
              .then(r => {
                if(!r.ok) throw new Error('Network error');
                return r.json();
              })
              .then(data => {
                fillTimeSlots(data);
              })
              .catch(err => {
                console.error('Failed to load timeslots', err);
                timeSlotSelect.innerHTML = '<option value=\"\">Ошибка загрузки</option>';
              });
    }

    // При изменении выбора учителя загружаем слоты
    teacherSelect?.addEventListener('change', function(){
      loadSlotsForTeacher(this.value);
    });

    // Если на загрузке странице уже выбран учитель (например single teacher), загрузим слоты
    document.addEventListener('DOMContentLoaded', function(){
      const initialTeacher = teacherSelect ? teacherSelect.value : '';
      if(initialTeacher) loadSlotsForTeacher(initialTeacher);
    });
  })();
</script>
</body>
</html>