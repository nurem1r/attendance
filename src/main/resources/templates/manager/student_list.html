<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Список студентов</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
</head>
<body>
<div class="container">
    <div class="header-row">
        <div class="header-left">
            <h1>Студенты</h1>
            <div class="small">Список студентов и быстрая отметка</div>
        </div>
        <div class="header-actions">
            <a th:href="@{/manager/add_student}" class="btn-consume">Добавить</a>
            <form th:action="@{/logout}" method="post" th:object="${_csrf}" style="margin-left:8px">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn-consume">Выйти</button>
            </form>
        </div>
    </div>

    <div class="controls">
        <input class="input" id="search" placeholder="Поиск по имени или коду..." />
        <div class="small">Фильтры доступны позже</div>
    </div>

    <div class="table-card">
        <table>
            <thead>
            <tr>
                <th>Фамилия и имя</th>
                <th>Пакет</th>
                <th>Остаток</th>
                <th>Стоимость (сом)</th>
                <th>Долг (сом)</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s: ${students}"
                th:classappend="${s.debt != null and s.debt > 0} ? ' row-debt' : (s.remainingLessons != null and s.remainingLessons < 2 ? ' row-low' : (s.remainingLessons != null and s.remainingLessons < 4 ? ' row-warn' : ''))">
                <td>
                    <div th:text="${s.lastName + ' ' + s.firstName}">ФИО</div>
                    <div class="kv" th:text="${s.phone}">телефон</div>
                </td>
                <td th:text="${s.packageCode != null ? s.packageCode : (s.lessonPackage != null ? s.lessonPackage.title : '-') }">Пакет</td>
                <td th:text="${s.remainingLessons == null ? '-' : s.remainingLessons}">0</td>
                <td th:text="${s.packagePrice == null ? '-' : s.packagePrice}">0</td>
                <!-- Новый столбец Долг -->
                <td th:text="${s.debt == null ? '-' : s.debt}">-</td>
                <td>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status.name() == 'PRESENT'}" class="pill present">Присутствует</span>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status.name() == 'LATE'}" class="pill late">Опоздал</span>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status.name() == 'ABSENT'}" class="pill absent">Отсутствует</span>
                    <span th:if="${!(todays != null and todays.containsKey(s.id))}" class="pill excused">Не отмечен</span>
                </td>
                <td>
                    <form th:action="@{/teacher/attendance/save}" method="post" style="display:inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" th:name="${'status_' + s.id}" value="PRESENT"/>
                        <button class="btn-letter p" type="submit">P</button>
                    </form>
                    <form th:action="@{/teacher/attendance/save}" method="post" style="display:inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" th:name="${'status_' + s.id}" value="LATE"/>
                        <button class="btn-letter l" type="submit">L</button>
                    </form>
                    <form th:action="@{/teacher/attendance/save}" method="post" style="display:inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" th:name="${'status_' + s.id}" value="ABSENT"/>
                        <button class="btn-letter a" type="submit">A</button>
                    </form>
                    <form th:action="@{/teacher/attendance/save}" method="post" style="display:inline">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" th:name="${'status_' + s.id}" value="EXCUSED"/>
                        <button class="btn-letter e" type="submit">E</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>