<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Список студентов</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
</head>
<body>
<div class="container">
    <div class="header-row">
        <div class="header-left">
            <h1>Студенты</h1>
            <div class="small">Список студентов и быстрая отметка</div>
        </div>
        <div class="header-actions">
            <a th:href="@{/manager}" class="btn-consume">Назад</a>
        </div>
    </div>

    <div class="controls">
        <form id="searchForm" th:action="@{/manager/student_list}" method="get" style="display:inline">
            <input class="input" id="search" name="q" th:value="${q}" placeholder="Поиск по имени..." autocomplete="off" />
        </form>
    </div>

    <div class="table-card">
        <table>
            <thead>
            <tr>
                <th>Фамилия и имя</th>
                <th>Пакет</th>
                <th>Книга</th>
                <th>Остаток</th>
                <th>Стоимость (сом)</th>
                <th>Долг (сом)</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s: ${students}"
                th:with="rc=${s.debt != null && s.debt > 0 ? 'row-debt' : (s.remainingLessons != null && s.remainingLessons < 2 ? 'row-low' : (s.remainingLessons != null && s.remainingLessons < 4 ? 'row-warn' : ''))}"
                th:class="${rc}">

                <td>
                    <div th:text="${s.lastName + ' ' + s.firstName}">ФИО</div>
                    <div class="kv" th:text="${s.phone}">телефон</div>
                </td>

                <td>
                    <span th:with="pkgCode=${s.packageCode != null ? s.packageCode : (s.lessonPackage != null ? s.lessonPackage.code : null)}"
                          th:switch="${pkgCode}">
                        <span th:case="'LESSONS_12_MWF'">12 Уроков (Пн-Ср-Пт)</span>
                        <span th:case="'LESSONS_12_TTS'">12 Уроков (Вт-Чт-Сб)</span>
                        <span th:case="'LESSONS_24'">24 урока</span>
                        <span th:case="null">-</span>
                        <span th:case="*"
                              th:text="${s.lessonPackage != null ? s.lessonPackage.title : pkgCode}">Пакет</span>
                    </span>
                </td>

                <!-- Book column: show Да or Нет -->
                <td th:text="${s.needsBook != null && s.needsBook == true ? 'Да' : 'Нет'}">Нет</td>

                <td th:text="${s.remainingLessons == null ? '-' : s.remainingLessons}">0</td>
                <td th:text="${s.packagePrice == null ? '-' : s.packagePrice}">0</td>
                <td th:text="${s.debt == null ? '-' : s.debt}">-</td>
                <td>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status != null and todays[s.id].status.name() == 'PRESENT'}" class="pill present">Присутствует</span>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status != null and todays[s.id].status.name() == 'LATE'}" class="pill late">Опоздал</span>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status != null and todays[s.id].status.name() == 'ABSENT'}" class="pill absent">Отсутствует</span>
                    <span th:if="${!(todays != null and todays.containsKey(s.id))}" class="pill excused">Не отмечен</span>
                </td>

                <td>
                    <a th:href="@{/manager/edit_student/{id}(id=${s.id})}" class="btn-letter" title="Редактировать">Изм</a>

                    <form th:action="@{/manager/delete_student}" method="post" style="display:inline"
                          th:attr="data-firstname=${s.firstName},data-lastname=${s.lastName}"
                          onsubmit="return confirmDelete(this);">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="studentId" th:value="${s.id}"/>
                        <button class="btn-letter delete" type="submit" title="Удалить">Удл</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Debounced auto-submit search form for better UX
    (function(){
        const input = document.getElementById('search');
        const form = document.getElementById('searchForm');
        if (!input || !form) return;
        let timer = null;
        input.addEventListener('input', function(){
            if (timer) clearTimeout(timer);
            timer = setTimeout(() => {
                form.submit();
            }, 300);
        });
        input.addEventListener('keydown', function(e){
            if (e.key === 'Enter') {
                e.preventDefault();
                form.submit();
            }
        });
    })();

    function confirmDelete(form) {
        try {
            const fn = form.getAttribute('data-firstname') || '';
            const ln = form.getAttribute('data-lastname') || '';
            const name = (ln + ' ' + fn).trim();
            const message = name ? ('Удалить студента ' + name + '?') : 'Удалить студента?';
            return confirm(message);
        } catch (e) {
            return confirm('Удалить студента?');
        }
    }
</script>

<style>
    .btn-letter { border:none; background:transparent; cursor:pointer; padding:4px 6px; margin-right:6px; text-decoration:none; }
    .btn-letter.delete { color:#c33; }
    a.btn-letter { display:inline-block; }

    .btn-letter { border:none; background:transparent; cursor:pointer; padding:4px 6px; margin-right:6px; text-decoration:none; }
    .btn-letter { color:#ed8936; }
    a.btn-letter { display:inline-block; }
</style>
</body>
</html>