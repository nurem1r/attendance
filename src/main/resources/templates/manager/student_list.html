<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>–°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
</head>
<body>
<div class="container">
    <div class="header-row">
        <div class="header-left">
            <h1>–°—Ç—É–¥–µ–Ω—Ç—ã</h1>
            <div class="small">–°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ –±—ã—Å—Ç—Ä–∞—è –æ—Ç–º–µ—Ç–∫–∞</div>
        </div>
        <div class="header-actions">
            <a th:href="@{/manager}" class="btn-consume">–ù–∞–∑–∞–¥</a>
            <!-- (—Ä–∞–Ω–µ–µ –±—ã–ª–∞ —Ñ–æ—Ä–º–∞ logout –∑–¥–µ—Å—å ‚Äî –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –∫–Ω–æ–ø–∫—É –ù–∞–∑–∞–¥ –ø–æ –∑–∞–ø—Ä–æ—Å—É) -->
        </div>
    </div>

    <div class="controls">
        <!-- –ü–æ–∏—Å–∫: GET —Ñ–æ—Ä–º–∞, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ q -->
        <form id="searchForm" th:action="@{/manager/student_list}" method="get" style="display:inline">
            <input class="input" id="search" name="q" th:value="${q}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –∫–æ–¥—É..." autocomplete="off" />
        </form>
    </div>

    <div class="table-card">
        <table>
            <thead>
            <tr>
                <th>–§–∞–º–∏–ª–∏—è –∏ –∏–º—è</th>
                <th>–ü–∞–∫–µ—Ç</th>
                <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (—Å–æ–º)</th>
                <th>–î–æ–ª–≥ (—Å–æ–º)</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="s: ${students}"
                th:with="rc=${s.debt != null && s.debt > 0 ? 'row-debt' : (s.remainingLessons != null && s.remainingLessons < 2 ? 'row-low' : (s.remainingLessons != null && s.remainingLessons < 4 ? 'row-warn' : ''))}"
                th:class="${rc}">

            <td>
                    <div th:text="${s.lastName + ' ' + s.firstName}">–§–ò–û</div>
                    <div class="kv" th:text="${s.phone}">—Ç–µ–ª–µ—Ñ–æ–Ω</div>
                </td>
                <td th:text="${s.packageCode != null ? s.packageCode : (s.lessonPackage != null ? s.lessonPackage.title : '-') }">–ü–∞–∫–µ—Ç</td>
                <td th:text="${s.remainingLessons == null ? '-' : s.remainingLessons}">0</td>
                <td th:text="${s.packagePrice == null ? '-' : s.packagePrice}">0</td>
                <td th:text="${s.debt == null ? '-' : s.debt}">-</td>
                <td>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status != null and todays[s.id].status.name() == 'PRESENT'}" class="pill present">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status != null and todays[s.id].status.name() == 'LATE'}" class="pill late">–û–ø–æ–∑–¥–∞–ª</span>
                    <span th:if="${todays != null and todays.containsKey(s.id) and todays[s.id].status != null and todays[s.id].status.name() == 'ABSENT'}" class="pill absent">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>
                    <span th:if="${!(todays != null and todays.containsKey(s.id))}" class="pill excused">–ù–µ –æ—Ç–º–µ—á–µ–Ω</span>
                </td>

                <td>
                    <a th:href="@{/manager/edit_student/{id}(id=${s.id})}" class="btn-letter" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</a>

                    <form th:action="@{/manager/delete_student}" method="post" style="display:inline"
                          th:attr="data-firstname=${s.firstName},data-lastname=${s.lastName}"
                          onsubmit="return confirmDelete(this);">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <input type="hidden" name="studentId" th:value="${s.id}"/>
                        <button class="btn-letter delete" type="submit" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // Debounced auto-submit search form for better UX
    (function(){
        const input = document.getElementById('search');
        const form = document.getElementById('searchForm');
        if (!input || !form) return;
        let timer = null;
        input.addEventListener('input', function(){
            if (timer) clearTimeout(timer);
            timer = setTimeout(() => {
                form.submit();
            }, 300); // submit 300ms after last keystroke
        });
        // allow Enter to submit immediately
        input.addEventListener('keydown', function(e){
            if (e.key === 'Enter') {
                e.preventDefault();
                form.submit();
            }
        });
    })();

    function confirmDelete(form) {
        try {
            const fn = form.getAttribute('data-firstname') || '';
            const ln = form.getAttribute('data-lastname') || '';
            const name = (ln + ' ' + fn).trim();
            const message = name ? ('–£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞ ' + name + '?') : '–£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞?';
            return confirm(message);
        } catch (e) {
            return confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞?');
        }
    }
</script>

<style>
    .btn-letter { border:none; background:transparent; cursor:pointer; padding:4px 6px; margin-right:6px; text-decoration:none; }
    .btn-letter.delete { color:#c33; }
    a.btn-letter { display:inline-block; }
</style>
</body>
</html>