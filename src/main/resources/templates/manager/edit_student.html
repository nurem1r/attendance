<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Редактировать студента</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
    <style>
        .hidden { display:none; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-row">
        <div class="header-left">
            <h1>Редактировать студента</h1>
            <div class="small">Обновите данные студента</div>
        </div>
        <div class="header-actions">
            <a th:href="@{/manager}" class="btn-consume">Назад</a>
        </div>
    </div>

    <div class="table-card">
        <form th:action="@{/manager/edit_student}" method="post" id="editStudentForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" name="id" th:value="${student.id}"/>

            <div class="form-row">
                <label>
                    Имя
                    <input class="input" type="text" name="firstName" th:value="${student.firstName}" required />
                </label>
                <label>
                    Фамилия
                    <input class="input" type="text" name="lastName" th:value="${student.lastName}" required />
                </label>
            </div>

            <div class="form-row">
                <label>
                    Телефон
                    <input class="input" type="text" name="phone" th:value="${student.phone}"/>
                </label>
                <label>
                    Учитель
                    <select class="input" name="teacherId" id="teacherSelect" required>
                        <option value="">-- выберите учителя --</option>
                        <option th:each="t : ${teachers}" th:value="${t.userId}"
                                th:text="${t.firstName + ' ' + t.lastName}"
                                th:selected="${student.teacherId != null and t.userId == student.teacherId}">Учитель</option>
                    </select>
                </label>
            </div>

            <div class="form-row">
                <label style="flex:2">
                    Пакет
                    <select class="input" name="packageId" id="packageSelect"
                            th:attr="data-current-package=${student.lessonPackage != null ? student.lessonPackage.id : 0}">
                        <option value="">-- выберите пакет --</option>
                        <option th:each="p : ${packages}"
                                th:value="${p.id}"
                                th:text="${p.title + ' — ' + p.price + ' сом'}"
                                th:attr="data-price=${p.price}"
                                th:selected="${student.lessonPackage != null && student.lessonPackage.id == p.id}">Пакет</option>
                    </select>
                </label>

                <!-- Сделано видимым по умолчанию, чтобы можно было редактировать платеж -->
                <label id="initialPaymentLabel">
                    Платёж (сом)
                    <input class="input" id="initialPayment" name="initialPayment" type="number" step="0.01" />
                </label>
            </div>

            <div class="form-row" style="margin-top:8px">
                <label style="flex:1">
                    Время
                    <select class="input" name="timeSlotId" id="timeSlotSelect">
                        <option value="">-- введите время --</option>
                        <option th:each="slot : ${slots}" th:value="${slot.id}" th:text="${slot.label}"
                                th:selected="${student.timeSlotId != null && slot.id == student.timeSlotId}">Слот</option>
                    </select>
                </label>

                <!-- Долг: только для просмотра -->
                <label style="width:220px; align-self:flex-end;">
                    Долг (сом)
                    <input class="input" id="debtInput" name="debt" type="number"
                           th:value="${student.debt != null ? student.debt : 0}" readonly />
                </label>
            </div>

            <!-- Заметка по оплате: скрыта до тех пор, пока был введён платёж -->
            <div class="form-row" id="paymentNoteRow" style="margin-top:12px; display:none;">
                <label style="flex:1">
                    Заметка по оплате
                    <input class="input" id="paymentNote" name="paymentNote" type="text" th:value="${student.paymentNote}" maxlength="512" />
                </label>
            </div>

            <div style="margin-top:12px">
                <button class="btn-consume" type="submit">Сохранить</button>
                <a th:href="@{/manager/student_list}" style="margin-left:8px" class="btn-consume">Отмена</a>
            </div>
        </form>
    </div>
</div>

<script>
    (function(){
        const packageSelect = document.getElementById('packageSelect');
        const initialPayment = document.getElementById('initialPayment');
        const initialPaymentLabel = document.getElementById('initialPaymentLabel');
        const debtInput = document.getElementById('debtInput');
        const paymentNoteRow = document.getElementById('paymentNoteRow');

        const currentPkgId = packageSelect ? parseInt(packageSelect.dataset.currentPackage || '0', 10) : 0;
        const originalDebt = parseFloat(debtInput ? (debtInput.value || '0') : '0') || 0;

        function getSelectedPackagePrice() {
            if (!packageSelect) return 0;
            const opt = packageSelect.options[packageSelect.selectedIndex];
            if (!opt) return 0;
            const price = parseFloat(opt.dataset.price);
            return Number.isFinite(price) ? price : 0;
        }

        function hideInitialPayment() {
            initialPaymentLabel.classList.add('hidden');
            initialPayment.value = '';
            paymentNoteRow.style.display = 'none';
        }

        function showInitialPayment() {
            initialPaymentLabel.classList.remove('hidden');
        }

        // when package selection changes
        function onPackageChange() {
            const selectedVal = packageSelect.value;
            if (!selectedVal) {
                hideInitialPayment();
                debtInput.value = originalDebt.toFixed(2);
                return;
            }

            const selectedId = parseInt(selectedVal, 10);
            const pkgPrice = getSelectedPackagePrice();

            // теперь поле платежа показывается и доступно для редактирования даже если выбран текущий пакет
            showInitialPayment();
            const paid = parseFloat(initialPayment.value || '0') || 0;
            const packageDebt = Math.max(0, (pkgPrice || 0) - paid);
            const resultingDebt = originalDebt + packageDebt;
            debtInput.value = resultingDebt.toFixed(2);
            paymentNoteRow.style.display = 'none';
        }

        function onInitialPaymentChange() {
            const pkgPrice = getSelectedPackagePrice();
            const paid = parseFloat(initialPayment.value || '0') || 0;
            const packageDebt = Math.max(0, (pkgPrice || 0) - paid);
            const resultingDebt = originalDebt + packageDebt;
            debtInput.value = resultingDebt.toFixed(2);

            const showNote = (!isNaN(paid) && paid > 0) || (initialPayment.value && initialPayment.value.trim() !== '');
            paymentNoteRow.style.display = showNote ? 'flex' : 'none';
        }

        document.addEventListener('DOMContentLoaded', function(){
            if (!packageSelect || !initialPayment || !debtInput) return;
            onPackageChange();
        });

        packageSelect?.addEventListener('change', onPackageChange);
        initialPayment?.addEventListener('input', onInitialPaymentChange);
    })();
</script>
</body>
</html>