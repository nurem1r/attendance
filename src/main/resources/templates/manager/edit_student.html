<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Редактировать студента</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
</head>
<body>
<div class="container">
    <div class="header-row">
        <div class="header-left">
            <h1>Редактировать студента</h1>
            <div class="small">Измените данные студента</div>
        </div>
        <div class="header-actions">
            <form th:action="@{/logout}" method="post" th:object="${_csrf}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn-consume">Выйти</button>
            </form>
        </div>
    </div>

    <div class="table-card">
        <form th:action="@{/manager/edit_student}" method="post" id="editStudentForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="id" th:value="${student.id}" />
            <!-- hidden current timeSlot for JS -->
            <input type="hidden" id="currentTimeSlotId" th:value="${student.timeSlotId}" />

            <div class="form-row">
                <label>
                    Фамилия
                    <input class="input" type="text" name="lastName" th:value="${student.lastName}" required />
                </label>
                <label>
                    Имя
                    <input class="input" type="text" name="firstName" th:value="${student.firstName}" required />
                </label>
            </div>

            <div class="form-row">
                <label>
                    Телефон
                    <input class="input" type="text" name="phone" th:value="${student.phone}" />
                </label>
                <label>
                    Учитель
                    <select class="input" name="teacherId" id="teacherSelect" required>
                        <option value="">-- выберите учителя --</option>
                        <option th:each="t : ${teachers}" th:value="${t.userId}" th:text="${t.firstName + ' ' + t.lastName}"
                                th:selected="${t.userId == student.teacherId}">Учитель</option>
                    </select>
                </label>
            </div>

            <div class="form-row">
                <label style="flex:2">
                    Пакет
                    <select class="input" name="packageId" id="packageSelect">
                        <option value="">-- оставить текущий пакет --</option>
                        <option th:each="p : ${packages}" th:value="${p.id}"
                                th:text="${p.title + ' — ' + p.price + ' сом'}"
                                th:selected="${(student.lessonPackage != null ? student.lessonPackage.id : student.packageId) == p.id}">Пакет</option>
                    </select>
                </label>

                <label>
                    Первичный платёж (сом)
                    <input class="input" type="number" step="0.01" name="initialPayment" value="0" />
                </label>
            </div>

            <!-- time slot -->
            <div class="form-row" style="margin-top:8px">
                <label style="flex:1">
                    Временной слот
                    <select class="input" name="timeSlotId" id="timeSlotSelect">
                        <option value="">-- выберите слот --</option>
                        <option th:each="slot : ${slots}" th:value="${slot.id}" th:text="${slot.label}"
                                th:selected="${slot.id == student.timeSlotId}">slot</option>
                    </select>
                </label>
                <div style="align-self:flex-end; margin-left:12px; color:#666; font-size:0.9em">
                    (опционально)
                </div>
            </div>

            <div class="form-row" style="margin-top:12px">
                <label>
                    Нужна книга
                    <input type="checkbox" name="book" th:checked="${student.needsBook}" />
                </label>

                <label>
                    Долг (сом)
                    <input class="input" type="number" step="0.01" name="debt" th:value="${student.debt}" />
                </label>
            </div>

            <div style="margin-top:12px">
                <button class="btn-consume" type="submit">Сохранить</button>
                <a th:href="@{/manager/student_list}" style="margin-left:8px" class="btn-consume">Отмена</a>
            </div>
        </form>
    </div>
</div>

<script>
    (function(){
        const teacherSelect = document.getElementById('teacherSelect');
        const timeSlotSelect = document.getElementById('timeSlotSelect');

        function fillTimeSlots(slots){
            timeSlotSelect.innerHTML = '';
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.textContent = '-- выберите слот --';
            timeSlotSelect.appendChild(emptyOpt);
            if(!slots || !Array.isArray(slots) || slots.length === 0){
                const none = document.createElement('option');
                none.value = '';
                none.textContent = 'Нет доступных слотов';
                timeSlotSelect.appendChild(none);
                return;
            }
            slots.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.label;
                timeSlotSelect.appendChild(opt);
            });
        }

        function loadSlotsForTeacher(teacherId){
            if(!teacherId){
                timeSlotSelect.innerHTML = '<option value=\"\">-- выберите учителя сначала --</option>';
                return;
            }
            fetch('/manager/teacher_slots_json/' + teacherId, { credentials: 'same-origin' })
                .then(r => {
                    if(!r.ok) throw new Error('Network error');
                    return r.json();
                })
                .then(data => {
                    fillTimeSlots(data);
                    // select existing timeSlotId if present in hidden input
                    const currentEl = document.getElementById('currentTimeSlotId');
                    const current = currentEl ? currentEl.value : '';
                    if(current) {
                        const opt = Array.from(timeSlotSelect.options).find(o => o.value === String(current));
                        if(opt) opt.selected = true;
                    }
                })
                .catch(err => {
                    console.error('Failed to load timeslots', err);
                    timeSlotSelect.innerHTML = '<option value=\"\">Ошибка загрузки</option>';
                });
        }

        teacherSelect?.addEventListener('change', function(){
            loadSlotsForTeacher(this.value);
        });

        document.addEventListener('DOMContentLoaded', function(){
            const initialTeacher = teacherSelect ? teacherSelect.value : '';
            if(initialTeacher) loadSlotsForTeacher(initialTeacher);
        });
    })();
</script>
</body>
</html>