<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Teacher Dashboard</title>
    <style>
        /* Strict / professional inline style for Teacher Dashboard (calendar removed) */
        :root{--bg:#f5f7fb;--card:#fff;--text:#0f1724;--muted:#6b7280;--primary:#0b5ed7;--border:#e6eefc;--radius:8px}
        *{box-sizing:border-box}
        body{margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text);padding:28px}
        .container{max-width:1100px;margin:0 auto}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
        .title{font-size:1.4rem;font-weight:700}
        .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;background:#f0f6ff;color:var(--primary);text-decoration:none;border:1px solid var(--border);font-weight:700}
        .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(8,20,50,0.04)}
        table{width:100%;border-collapse:collapse}
        thead th{background:var(--primary);color:#fff;padding:10px;text-align:left;font-weight:700}
        tbody td{padding:10px;border-bottom:1px solid #eef4ff}
        .btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#093a88);color:#fff}
        .btn-ghost{background:#fff;border:1px solid var(--border);color:var(--primary)}
        .center{display:flex;justify-content:center}
        .status-chip{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:0.85rem}
        .chip-present{background:#e9f7ef;color:#0b6b3a}
        .chip-absent{background:#fff1f0;color:#8b1c1c}
        .chip-late{background:#fff7ed;color:#7a4c11}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="title">Teacher Dashboard</div>
        <a th:href="@{/}" class="back">Back</a>
    </div>

    <div class="card">
        <!-- Calendar removed as requested. The page works in "current day" mode (controller should handle default date). -->

        <form id="attendanceForm" th:action="@{/teacher/attendance/save}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <table>
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Package</th>
                    <th>Remaining</th>
                    <th>Check-in</th>
                    <th>Status</th>
                    <th>Quick</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="s : ${students}" th:attr="data-id=${s.id}">
                    <td th:text="${s.firstName + ' ' + s.lastName}">Name</td>
                    <td th:text="${s.studentCode}">Code</td>
                    <td th:text="${s.packageType}">PKG</td>
                    <td th:text="${s.remainingLessons != null ? s.remainingLessons : 0}">0</td>
                    <td th:text="${todays != null && todays.containsKey(s.id) ? todays[s.id].checkinTime : '-'}">-</td>
                    <td>
                        <span th:if="${todays != null && todays.containsKey(s.id) && todays[s.id].status.name() == 'PRESENT'}" class="status-chip chip-present">PRESENT</span>
                        <span th:if="${todays != null && todays.containsKey(s.id) && todays[s.id].status.name() == 'ABSENT'}" class="status-chip chip-absent">ABSENT</span>
                        <span th:if="${todays != null && todays.containsKey(s.id) && todays[s.id].status.name() == 'LATE'}" class="status-chip chip-late">LATE</span>
                        <span th:if="${todays == null or !todays.containsKey(s.id)}" class="small" style="color:var(--muted)">Not marked</span>
                    </td>
                    <td>
                        <div style="display:flex;gap:8px">
                            <!-- type="button" to avoid accidental form submission -->
                            <button type="button" class="btn btn-primary" th:onclick="|markAndSubmit(${s.id}, 'PRESENT')|">PRESENT</button>
                            <button type="button" class="btn btn-ghost" th:onclick="|markAndSubmit(${s.id}, 'ABSENT')|">ABSENT</button>
                            <button type="button" class="btn btn-ghost" th:onclick="|markAndSubmit(${s.id}, 'LATE')|">LATE</button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </form>

    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    var saveUrl = /*[[ @{/teacher/attendance/save} ]]*/ '/teacher/attendance/save';
    var csrfName = /*[[ ${_csrf.parameterName} ]]*/ '_csrf';
    var csrfToken = /*[[ ${_csrf.token} ]]*/ '';

    function markAndSubmit(studentId, status) {
        // create a temporary form and submit single student's status
        var form = document.createElement('form');
        form.method = 'post';
        form.action = saveUrl;

        // CSRF
        if (csrfName && csrfToken) {
            var cs = document.createElement('input');
            cs.type = 'hidden';
            cs.name = csrfName;
            cs.value = csrfToken;
            form.appendChild(cs);
        }

        // single status param, controller should accept status_<id>
        var s = document.createElement('input');
        s.type = 'hidden';
        s.name = 'status_' + studentId;
        s.value = status;
        form.appendChild(s);

        // append and submit
        document.body.appendChild(form);
        form.submit();
    }
    /*]]>*/
</script>
</body>
</html>