<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Дашборд учителя</title>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
</head>
<body>
<div class="container">
    <div class="header-row">
        <div class="header-left">
            <h1>Дашборд учителя</h1>
            <div class="small">Просмотр и отметка посещаемости</div>
        </div>
        <div class="header-actions">
            <form th:action="@{/logout}" method="post" th:object="${_csrf}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="login-btn small">Выйти</button>
            </form>
        </div>
    </div>

    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-number" th:text="${students != null ? #lists.size(students) : 0}">0</div>
            <div class="stat-label">Всего студентов</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${presentCount}">0</div>
            <div class="stat-label">Присутствует</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${lateCount}">0</div>
            <div class="stat-label">Опоздали</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${absentCount}">0</div>
            <div class="stat-label">Отсутствуют</div>
        </div>
    </div>

    <div class="controls">
        <input class="input" id="searchInput" placeholder="Поиск по имени или коду..." />
        <input class="input" type="date" id="attendanceDate" th:value="${today}" />
        <button class="login-btn small" id="loadBtn">Загрузить</button>
        <div class="small">Выберите дату для отметки (можно прошлые дни)</div>
    </div>

    <div class="table-card">
        <form id="attendanceForm" th:action="@{/teacher/attendance/save}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" name="date" id="formDate" th:value="${today}" />

            <table>
                <thead>
                <tr>
                    <th>Фамилия и имя</th>
                    <th>Пакет</th>
                    <th>Остаток</th>
                    <th>Стоимость (сом)</th>
                    <th>Долг (сом)</th>
                    <th>Статус</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody id="studentsTbody">
                <tr th:each="s : ${students}"
                    th:with="rc=${rowClassMap != null && rowClassMap.containsKey(s.id) ? rowClassMap[s.id] : ''}"
                    th:class="${rc}">
                    <td>
                        <div th:text="${s.lastName + ' ' + s.firstName}">Иванов Иван</div>
                        <div class="kv" th:text="${s.phone}">phone</div>
                    </td>
                    <td th:text="${s.lessonPackage != null ? s.lessonPackage.title : (s.packageCode != null ? s.packageCode : '-') }">Пакет</td>
                    <td th:text="${s.remainingLessons == null ? '-' : s.remainingLessons}">0</td>
                    <td th:text="${s.packagePrice == null ? '-' : s.packagePrice}">0</td>
                    <!-- Новый столбец Долг -->
                    <td th:text="${s.debt == null ? '-' : s.debt}">-</td>
                    <td>
                        <span th:if="${todays != null and todays[s.id] != null and todays[s.id].status != null and todays[s.id].status.name() == 'PRESENT'}" class="pill present">Присутствует</span>
                        <span th:if="${todays != null and todays[s.id] != null and todays[s.id].status != null and todays[s.id].status.name() == 'LATE'}" class="pill late">Опоздал</span>
                        <span th:if="${todays != null and todays[s.id] != null and todays[s.id].status != null and todays[s.id].status.name() == 'ABSENT'}" class="pill absent">Отсутствует</span>
                        <span th:if="${!(todays != null and todays[s.id] != null)}" class="pill excused">Не отмечен</span>
                    </td>
                    <td>
                        <button type="button" class="btn-letter p" th:onclick="|markAndSet(${s.id},'PRESENT')|">P</button>
                        <button type="button" class="btn-letter l" th:onclick="|markAndSet(${s.id},'LATE')|">L</button>
                        <button type="button" class="btn-letter a" th:onclick="|markAndSet(${s.id},'ABSENT')|">A</button>
                        <button type="button" class="btn-letter e" th:onclick="|markAndSet(${s.id},'EXCUSED')|">E</button>
                        <button type="button" class="btn-consume" th:onclick="|consume(${s.id}, this)|">-1 урок</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div style="margin-top:12px">
                <button type="submit" class="login-btn">Сохранить отметки</button>
            </div>
        </form>
    </div>
</div>

<script>
    /* simplified JS omitted for brevity (unchanged) */
</script>
</body>
</html>