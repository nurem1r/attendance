<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
</head>
<body>
<div th:fragment="student_status(student, missed, teacherName)">
    <div style="border:1px solid #ccc;padding:10px;">
        <h3 th:text="${student.firstName + ' ' + student.lastName}">Student Name</h3>
        <p>Phone: <span th:text="${student.phone}">-</span></p>
        <p>Debt: <strong th:text="${student.debt != null ? student.debt : 0}">0</strong></p>

        <!-- Payment form - visible only to MANAGER and ADMIN -->
        <div sec:authorize="hasAnyRole('MANAGER','ADMIN')" style="margin-top:8px;border-top:1px dashed #ddd;padding-top:8px;">
            <form th:action="@{/payments/pay}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="studentId" th:value="${student.id}" />
                <div>
                    <label>Amount:
                        <input type="number" step="0.01" name="amount" required />
                    </label>
                </div>
                <div>
                    <label>Note:
                        <input type="text" name="note"/>
                    </label>
                </div>
                <div style="margin-top:6px;">
                    <button type="submit">Add Payment</button>
                </div>
            </form>
        </div>

        <p>Book: <span th:text="${student.book}">-</span></p>

        <p>Total lessons:
            <span th:switch="${student.packageType}">
                <span th:case="T(com.example.attendance.enums.PackageType).LESSONS_12">12</span>
                <span th:case="T(com.example.attendance.enums.PackageType).LESSONS_24">24</span>
                <span th:case="T(com.example.attendance.enums.PackageType).UNLIMITED">∞</span>
                <span th:case="*">-</span>
            </span>
        </p>

        <p>Used: <span th:text="${student.usedLessons != null ? student.usedLessons : 0}">0</span></p>

        <p>Remaining:
            <span th:if="${student.packageType != null and student.packageType.name() == 'UNLIMITED'}">∞</span>
            <span th:unless="${student.packageType != null and student.packageType.name() == 'UNLIMITED'}"
                  th:text="${student.remainingLessons != null ? student.remainingLessons : 0}">0</span>
        </p>

        <p>Progress:
            <progress th:attr="value=${student.usedLessons != null ? student.usedLessons : 0},max=${student.packageType != null and student.packageType.name()=='UNLIMITED' ? 100 : ( (student.usedLessons != null ? student.usedLessons : 0) + (student.remainingLessons != null ? student.remainingLessons : 0) )}"></progress>
        </p>

        <p>Missed this month: <span th:text="${missed != null ? missed : 0}">0</span></p>

        <p th:if="${student.remainingLessons != null and student.packageType != null and student.packageType.name() != 'UNLIMITED' and student.remainingLessons < 4}" style="color:red;">
            Warning: low remaining
        </p>

        <!-- Recent payments -->
        <div style="margin-top:8px;">
            <h5>Recent payments</h5>
            <ul th:if="${payments != null}" th:each="p : ${payments}">
                <li>
                    <span th:text="${p.paidAt}">date</span> — <strong th:text="${p.amount}">0</strong>
                    <span th:if="${p.note != null}"> — <span th:text="${p.note}"></span></span>
                </li>
            </ul>
            <div th:if="${payments == null or #lists.isEmpty(payments)}">No payments yet</div>
        </div>

    </div>
</div>
</body>
</html>